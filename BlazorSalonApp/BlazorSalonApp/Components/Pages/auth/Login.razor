@page "/login"
@using BlazorSalonApp.Dto
@using BlazorSalonApp.Services
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<div class="login-container">
    <div class="login-card">
        <h2>Login</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
        <div class="alert alert-danger">
            @errorMessage
        </div>
        }

        <EditForm Model="@loginRequest" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label>Username</label>
                <InputText @bind-Value="loginRequest.Username" class="form-control" placeholder="Enter username" />
                <ValidationMessage For="@(() => loginRequest.Username)" />
            </div>

            <div class="form-group">
                <label>Password</label>
                <InputText type="password" @bind-Value="loginRequest.Password" class="form-control" placeholder="Enter password" />
                <ValidationMessage For="@(() => loginRequest.Password)" />
            </div>

            <button type="submit" class="btn btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                <span>Logging in...</span>
                }
                else
                {
                <span>Login</span>
                }
            </button>
        </EditForm>
    </div>
</div>

@code {
private LoginRequest loginRequest = new();
private string? errorMessage;
private bool isLoading = false;

private async Task HandleLogin()
{
try
{
isLoading = true;
errorMessage = null;

var response = await AuthService.LoginAsync(loginRequest);

// Redirect based on role
if (response.Role == "SYSTEM_ADMIN")
{
Navigation.NavigateTo("/admin/dashboard");
}
else if (response.Role == "BUSINESS_OWNER")
{
Navigation.NavigateTo("/business/dashboard");
}
else
{
Navigation.NavigateTo("/");
}
}
        catch (Exception)
        {
            errorMessage = "Login failed. Check username and password.";
        }
finally
{
isLoading = false;
}
}
}
