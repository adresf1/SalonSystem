@page "/business/services"
@using BlazorSalonApp.Dto
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Manage Services</PageTitle>

<div class="services-container">
    <div class="header">
        <h1>‚úÇÔ∏è My Services</h1>
        <button class="btn btn-primary" @onclick="ShowAddService">+ Add Service</button>
    </div>

    @if (isLoading)
    {
        <div class="loading">Loading services...</div>
    }
    else if (services.Any())
    {
        <div class="services-grid">
            @foreach (var service in services)
            {
                <div class="service-card @(service.Active ? "" : "inactive")">
                    <div class="service-header">
                        <h3>@service.Name</h3>
                        <span class="status-badge @(service.Active ? "active" : "inactive")">
                            @(service.Active ? "Active" : "Inactive")
                        </span>
                    </div>
                    <div class="service-details">
                        <div class="detail-row">
                            <span class="label">‚è±Ô∏è Duration:</span>
                            <span class="value">@service.DurationMinutes min</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">üí∞ Price:</span>
                            <span class="value">@service.Price kr</span>
                        </div>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-secondary" @onclick="() => EditService(service)">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteService(service.Id)">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <p>üì≠ No services yet</p>
            <button class="btn btn-primary" @onclick="ShowAddService">Add your first service</button>
        </div>
    }

    @if (showServiceDialog)
    {
        <div class="dialog-overlay" @onclick="CloseDialog">
            <div class="dialog" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h2>@(editingService == null ? "Add Service" : "Edit Service")</h2>
                    <button class="btn-close" @onclick="CloseDialog">‚úï</button>
                </div>
                <EditForm Model="serviceRequest" OnValidSubmit="SaveService">
                    <DataAnnotationsValidator />
                    <div class="form-group">
                        <label>Name</label>
                        <InputText @bind-Value="serviceRequest.Name" class="form-control" placeholder="e.g. Men's Haircut" />
                        <ValidationMessage For="@(() => serviceRequest.Name)" />
                    </div>
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <InputNumber @bind-Value="serviceRequest.DurationMinutes" class="form-control" />
                        <ValidationMessage For="@(() => serviceRequest.DurationMinutes)" />
                    </div>
                    <div class="form-group">
                        <label>Price (kr)</label>
                        <InputNumber @bind-Value="serviceRequest.Price" class="form-control" />
                        <ValidationMessage For="@(() => serviceRequest.Price)" />
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <InputCheckbox @bind-Value="serviceRequest.Active" />
                            Active (visible to customers)
                        </label>
                    </div>
                    <div class="dialog-actions">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @(isSaving ? "Saving..." : "Save")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    private List<ServiceResponse> services = new();
    private bool isLoading = true;
    private bool showServiceDialog = false;
    private bool isSaving = false;
    private ServiceResponse? editingService;
    private ServiceRequest serviceRequest = new() { Active = true };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            Navigation.NavigateTo("/auth/login");
            return;
        }

        await LoadServices();
    }

    private async Task LoadServices()
    {
        try
        {
            isLoading = true;
            services = await ApiService.GetMyServicesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading services: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddService()
    {
        editingService = null;
        serviceRequest = new ServiceRequest { Active = true };
        showServiceDialog = true;
    }

    private void EditService(ServiceResponse service)
    {
        editingService = service;
        serviceRequest = new ServiceRequest
        {
            Name = service.Name,
            DurationMinutes = service.DurationMinutes,
            Price = service.Price,
            Active = service.Active
        };
        showServiceDialog = true;
    }

    private async Task SaveService()
    {
        try
        {
            isSaving = true;
            
            if (editingService == null)
            {
                await ApiService.AddServiceAsync(serviceRequest);
            }
            else
            {
                await ApiService.UpdateServiceAsync(editingService.Id, serviceRequest);
            }
            
            await LoadServices();
            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving service: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteService(long serviceId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this service?"))
            return;

        try
        {
            await ApiService.DeleteServiceAsync(serviceId);
            await LoadServices();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting service: {ex.Message}");
        }
    }

    private void CloseDialog()
    {
        showServiceDialog = false;
        editingService = null;
        serviceRequest = new ServiceRequest { Active = true };
    }
}
